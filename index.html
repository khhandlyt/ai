<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç»˜å›¾æç¤ºè¯æ¶¦è‰²ä¸ç”Ÿæˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-10 max-w-5xl">
        <!-- Header -->
        <header class="text-center mb-16">
            <h1 class="text-4xl font-bold text-gray-800 mb-4 text-shadow">AI ç»˜å›¾æç¤ºè¯æ¶¦è‰²ä¸ç”Ÿæˆå·¥å…·</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                è¾“å…¥æ‚¨çš„ç»˜å›¾æƒ³æ³•ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æ¶¦è‰²ä¸ºä¸“ä¸šçš„AIç»˜å›¾æç¤ºè¯ï¼Œå¹¶ç”Ÿæˆç²¾ç¾çš„å›¾åƒ
            </p>
        </header>
        
        <main>
            <!-- Form Section -->
            <section class="bg-white rounded-xl shadow-md p-8 mb-10 card-hover">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">è¾“å…¥åŸå§‹æç¤ºè¯</h2>
                <form id="promptForm" class="space-y-6">
                    <div>
                        <label for="originalPrompt" class="block text-lg font-medium text-gray-700 mb-2">
                            è¯·æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾åƒ
                        </label>
                        <textarea 
                            id="originalPrompt" 
                            rows="5" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-3 focus:ring-blue-500 focus:border-transparent transition-all"
                            placeholder="ä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„çŒ«å’ªåœ¨è‰åœ°ä¸Šç©è€"
                        ></textarea>
                    </div>
                    <button 
                        type="submit" 
                        class="w-full bg-blue-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    >
                        ğŸ¨ ç”Ÿæˆå›¾åƒ
                    </button>
                </form>
            </section>
            
            <!-- Refined Prompt Section -->
            <section id="refinedSection" class="bg-white rounded-xl shadow-md p-8 mb-10 card-hover hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">æ¶¦è‰²åçš„ä¸“ä¸šæç¤ºè¯</h2>
                <div 
                    id="refinedPrompt" 
                    class="bg-gray-50 p-5 rounded-lg text-gray-700 border border-gray-100 whitespace-pre-wrap"
                ></div>
            </section>
            
            <!-- Image Result Section -->
            <section id="imageSection" class="bg-white rounded-xl shadow-md p-8 mb-10 card-hover hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">ç”Ÿæˆçš„å›¾åƒ</h2>
                <div id="imageContainer" class="flex flex-col items-center">
                    <!-- Image will be inserted here -->
                    <div class="mt-6 text-gray-500 text-sm" id="imageInfo">
                        ç‚¹å‡»å›¾åƒå¯æŸ¥çœ‹åŸå§‹å°ºå¯¸
                    </div>
                </div>
                <div class="mt-8">
                    <button 
                        id="generateVideoBtn" 
                        class="w-full bg-purple-600 text-white font-medium py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2"
                    >
                        ğŸ¬ åŸºäºæ­¤å›¾åƒç”Ÿæˆè§†é¢‘
                    </button>
                </div>
            </section>
            
            <!-- Video Result Section -->
            <section id="videoSection" class="bg-white rounded-xl shadow-md p-8 mb-10 card-hover hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">ç”Ÿæˆçš„è§†é¢‘</h2>
                <div id="videoContainer" class="flex flex-col items-center">
                    <!-- Video will be inserted here -->
                </div>
            </section>
            
            <!-- Loading Indicators -->
            <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white p-8 rounded-xl shadow-xl max-w-sm w-full">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
                    <p class="mt-6 text-center text-gray-700 text-lg font-medium" id="loadingText">
                        å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
                    </p>
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="error" class="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-lg mb-10 hidden" role="alert">
                <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0 text-red-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                    <div class="ml-3">
                        <p class="font-medium">é”™è¯¯</p>
                        <p class="mt-1 text-red-600" id="errorMessage">å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚</p>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center text-gray-600 mt-16 pb-8">
            <p class="text-lg">Â© 2026 AI ç»˜å›¾å·¥å…·</p>
            <p class="mt-2 text-sm">åŸºäº Volcengine ARK API æ„å»º</p>
        </footer>
    </div>
    
    <script>
        // API Configuration
        const API_KEY = "0fd0feed-e56d-4665-93c7-ed682c9c23f1";
        const BASE_URL = "https://ark.cn-beijing.volces.com/api/v3";
        
        // DOM Elements
        const form = document.getElementById('promptForm');
        const originalPrompt = document.getElementById('originalPrompt');
        const refinedSection = document.getElementById('refinedSection');
        const refinedPrompt = document.getElementById('refinedPrompt');
        const imageSection = document.getElementById('imageSection');
        const imageContainer = document.getElementById('imageContainer');
        const generateVideoBtn = document.getElementById('generateVideoBtn');
        const videoSection = document.getElementById('videoSection');
        const videoContainer = document.getElementById('videoContainer');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        
        // Store generated image URL
        let generatedImageUrl = '';
        
        // Show loading with message
        function showLoading(message = 'å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...') {
            loadingText.textContent = message;
            loading.classList.remove('hidden');
        }
        
        // Hide loading
        function hideLoading() {
            loading.classList.add('hidden');
        }
        
        // Show error
        function showError(msg) {
            errorMessage.textContent = msg;
            error.classList.remove('hidden');
        }
        
        // Hide error
        function hideError() {
            error.classList.add('hidden');
        }
        
        // Form submit handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            
            const userInput = originalPrompt.value.trim();
            if (!userInput) {
                showError('è¯·è¾“å…¥åŸå§‹æç¤ºè¯');
                return;
            }
            
            try {
                // Step 1: Refine the prompt
                showLoading('æ­£åœ¨æ¶¦è‰²æç¤ºè¯...');
                
                // Construct the refinement prompt
                const refinementPrompt = `è¯·å°†ä»¥ä¸‹æ–‡æœ¬æ¶¦è‰²ä¸ºé€‚åˆAIç”Ÿæˆå›¾ç‰‡çš„ä¸“ä¸šæç¤ºè¯ï¼š
${userInput}

æ¶¦è‰²è¦æ±‚ï¼š
1. è¡¥å……ç”»é¢ç»†èŠ‚ï¼ˆæ„å›¾ã€å…‰çº¿ã€è‰²å½©ã€æè´¨ã€åˆ†è¾¨ç‡ï¼‰
2. åŠ å…¥AIç»˜å›¾å¸¸ç”¨é£æ ¼æœ¯è¯­ï¼ˆå¦‚å†™å®ä¸»ä¹‰ã€äºŒæ¬¡å…ƒã€èµ›åšæœ‹å…‹ã€æ²¹ç”»è´¨æ„Ÿï¼‰
3. ä¿æŒåŸæ„ä¸å˜ï¼Œè¯­è¨€ç²¾å‡†ä¸”ç¬¦åˆAIç»˜å›¾æç¤ºè¯çš„è¡¨è¾¾ä¹ æƒ¯
4. ç›´æ¥è¾“å‡ºæ¶¦è‰²åçš„æç¤ºè¯ï¼Œæ— éœ€é¢å¤–è§£é‡Š`;
                
                const refineResponse = await fetch(`${BASE_URL}/responses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-v3-2-251201",
                        input: [{"role": "user", "content": refinementPrompt}]
                    })
                });
                
                if (!refineResponse.ok) {
                    throw new Error(`æ¶¦è‰²æç¤ºè¯å¤±è´¥ï¼š${refineResponse.statusText}`);
                }
                
                const refineData = await refineResponse.json();
                const refinedText = refineData.output[0].content[0].text;
                refinedPrompt.textContent = refinedText;
                refinedSection.classList.remove('hidden');
                
                // Step 2: Generate image
                showLoading('æ­£åœ¨ç”Ÿæˆå›¾åƒ...');
                
                const imageResponse = await fetch(`${BASE_URL}/images/generations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "doubao-seedream-4-5-251128",
                        prompt: refinedText,
                        size: "2K",
                        response_format: "url",
                        watermark: true
                    })
                });
                
                if (!imageResponse.ok) {
                    throw new Error(`ç”Ÿæˆå›¾åƒå¤±è´¥ï¼š${imageResponse.statusText}`);
                }
                
                const imageData = await imageResponse.json();
                const imageUrl = imageData.data[0].url;
                
                // Store generated image URL
                generatedImageUrl = imageUrl;
                
                // Display image
                imageContainer.innerHTML = `
                    <a href="${imageUrl}" target="_blank" rel="noopener noreferrer">
                        <img 
                            src="${imageUrl}" 
                            alt="ç”Ÿæˆçš„å›¾åƒ" 
                            class="max-w-full h-auto rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                        >
                    </a>
                `;
                imageSection.classList.remove('hidden');
                
                // Scroll to results
                refinedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        });
        
        // Generate video from image
        generateVideoBtn.addEventListener('click', async () => {
            if (!generatedImageUrl) {
                showError('è¯·å…ˆç”Ÿæˆå›¾åƒï¼Œç„¶åå†ç”Ÿæˆè§†é¢‘');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡...');
                
                // Create video generation task
                const videoResponse = await fetch(`${BASE_URL}/contents/generations/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "doubao-seedance-1-0-pro-fast-251015",
                        content: [
                            {
                                "type": "text",
                                "text": `åŸºäºæä¾›çš„å›¾åƒç”Ÿæˆè§†é¢‘ï¼Œä¿æŒé£æ ¼ä¸€è‡´ï¼Œå±•ç¤ºåŠ¨æ€æ•ˆæœ  --resolution 1080p  --duration 5 --camerafixed false --watermark true`
                            },
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": generatedImageUrl
                                }
                            }
                        ]
                    })
                });
                
                if (!videoResponse.ok) {
                    const errorData = await videoResponse.json();
                    throw new Error(`åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡å¤±è´¥ï¼š${errorData.error?.message || videoResponse.statusText}`);
                }
                
                const videoData = await videoResponse.json();
                const taskId = videoData.id;
                
                // Start polling for task status
                await pollVideoTaskStatus(taskId);
                
            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading();
            }
        });
        
        // Poll video task status
        async function pollVideoTaskStatus(taskId) {
            let attempts = 0;
            const maxAttempts = 50; // 3 seconds * 50 = 150 seconds = 2.5 minutes
            
            while (attempts < maxAttempts) {
                showLoading(`è§†é¢‘ç”Ÿæˆä¸­ï¼Œå½“å‰è¿›åº¦ï¼š${Math.min(Math.round((attempts/maxAttempts)*100), 95)}%...`);
                
                try {
                    const statusResponse = await fetch(`${BASE_URL}/contents/generations/tasks/${taskId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`
                        }
                    });
                    
                    if (!statusResponse.ok) {
                        throw new Error(`æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼š${statusResponse.statusText}`);
                    }
                    
                    const statusData = await statusResponse.json();
                    const status = statusData.status;
                    
                    if (status === "succeeded") {
                        showLoading('è§†é¢‘ç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨å¤„ç†ç»“æœ...');
                        
                        // Display video
                        const videoUrl = statusData.content.video_url;
                        videoContainer.innerHTML = `
                            <div class="w-full max-w-2xl">
                                <!-- Video Preview -->
                                <div class="bg-gray-900 rounded-lg overflow-hidden mb-6">
                                    <video 
                                        src="${videoUrl}" 
                                        controls 
                                        class="w-full"
                                        poster="${generatedImageUrl}"
                                    >
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                                    </video>
                                </div>
                                
                                <!-- Video Info and Actions -->
                                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                                    <div>
                                        <p class="text-lg font-medium text-gray-800 mb-1">ç”Ÿæˆçš„è§†é¢‘</p>
                                        <p class="text-sm text-gray-600">è§†é¢‘åˆ†è¾¨ç‡ï¼š1080p | æ—¶é•¿ï¼š5ç§’</p>
                                    </div>
                                    <a 
                                        href="${videoUrl}" 
                                        download="generated_video.mp4" 
                                        class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                    >
                                        ğŸ’¾ ä¸‹è½½è§†é¢‘
                                    </a>
                                </div>
                            </div>
                        `;
                        videoSection.classList.remove('hidden');
                        
                        // Scroll to video section
                        videoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        
                        return;
                    } else if (status === "failed") {
                        throw new Error(`è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼š${statusData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                    } else if (status === "cancelled" || status === "expired") {
                        throw new Error(`è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²${status === "cancelled" ? 'å–æ¶ˆ' : 'è¿‡æœŸ'}`);
                    }
                    
                    // Wait for 3 seconds before next poll
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    attempts++;
                    
                } catch (err) {
                    throw err;
                }
            }
            
            throw new Error('è§†é¢‘ç”Ÿæˆä»»åŠ¡è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
        }
    </script>
</body>
</html>